# =============================================================================
# RebelDev Enhanced Auto Scanner - GitHub Actions Workflow
# Description: Automated VPN configuration validation with performance testing
# Schedule: Hourly execution for fresh configuration updates
# Version: 4.7.0
# =============================================================================

name: "üöÄ RebelDev - Improved Auto Config Scanner"

on:
  schedule:
    - cron: '0 * * * *'  # Hourly
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh all configurations'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.12'  # Updated to latest stable
  SCANNER_VERSION: '4.7.0'

jobs:
  improved-scan-and-deploy:
    name: "üîç Improved Scan & Deploy"
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: "üîÑ Checkout Repository"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: "üêç Setup Python Environment"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: "üì¶ Install Dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp requests
          echo "‚úÖ Dependencies installed"

      - name: "üîß Setup System Permissions"
        run: |
          sudo sysctl -w net.ipv4.ping_group_range="0 2147483647" || true
          sudo apt-get update && sudo apt-get install -y curl || true
          echo "‚úÖ System permissions configured"

      - name: "üßπ Clean Cache"
        run: |
          rm -rf RebelLink || true
          echo "‚úÖ Cache and output cleaned"

      - name: "üöÄ Execute Improved Scanner"
        run: |
          echo "Starting improved VPN configuration scan v${{ env.SCANNER_VERSION }}..."
          echo "This may take up to 30-40 minutes due to global latency..."
          timeout 40m python auto_scanner.py
          if [ $? -ne 0 ]; then
            echo "‚ùå Scanner failed - Check logs"
            exit 1
          fi
          echo "‚úÖ Scanner execution completed"

      - name: "‚úÖ Validate Output"
        run: |
          echo "Validating generated configurations..."
          if [ -d "RebelLink" ]; then
            echo "üìÅ RebelLink directory found"
            sub_count=$(find RebelLink -name "*_subscriptions.txt" -type f | wc -l)
            echo "üìä Found $sub_count subscription files (user-ready base64 links)"

            total_configs=$(grep -c '^[^#]' RebelLink/*_subscriptions.txt 2>/dev/null || echo 0)
            echo "üìà Total valid configs: $total_configs"

            if [ -f "RebelLink/performance_report.json" ]; then
              echo "üìä Performance report generated"
              cat << 'EOF' > validate_report.py
import json
try:
    with open('RebelLink/performance_report.json', 'r') as f:
        report = json.load(f)
    print(f"‚úÖ Scan completed: {report['scan_timestamp']}")
    print(f"üìã Processed: {report['performance_metrics']['total_processed']}")
    print(f"‚úÖ Valid: {report['performance_metrics']['valid_configs']}")
    print(f"üìä Success rate: {report['performance_metrics']['success_rate']}%")
    print(f"‚ö° Avg Latency: {report['performance_metrics']['avg_latency_ms']}ms")
    print(f"‚≠ê Avg Score: {report['performance_metrics']['avg_score']}")
except Exception as e:
    print(f"‚ö†Ô∏è Report read error: {e}")
EOF
              python validate_report.py
              rm validate_report.py
            else
              echo "‚ö†Ô∏è Performance report not found"
              exit 1
            fi

            if [ $sub_count -eq 0 ]; then
              echo "‚ùå No subscription files generated"
              exit 1
            fi
          else
            echo "‚ùå RebelLink directory not found"
            exit 1
          fi
          echo "‚úÖ Validation passed"

      - name: "üîÑ Deploy Configurations"
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "RebelDev Improved Scanner"

          if git diff --quiet HEAD -- RebelLink/; then
            echo "üü° No configuration changes detected - Skipping commit"
          else
            git add RebelLink/
            valid_count=$(python -c "import json; d=json.load(open('RebelLink/performance_report.json')); print(d['performance_metrics']['valid_configs'])")
            timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "ü§ñ Improved Auto-Update: VPN Configurations ${timestamp}" \
                        -m "Enhanced scanner v${{ env.SCANNER_VERSION }} with base64 subscriptions & relay tests" \
                        -m "Features: Async fetch, Real VPN relay (curl), Cache retention (7 days), User-ready links" \
                        -m "Success: ${valid_count} valid configs"
            git push
            echo "‚úÖ Configuration updates deployed to main branch"
          fi

      - name: "üì§ Upload Artifacts (Optional)"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rebeldev-scan-results
          path: |
            RebelLink/
            scanner.log
          retention-days: 7
          if-no-files-found: ignore
